<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ito - The Game</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3a98db"/>
    <style>
        /* --- General Styles --- */
        :root {
            --primary-color: #3a98db;
            --secondary-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 1rem;
        }
        #app-container {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
        h1 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        h2 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            margin: 0.25rem;
        }
        button:hover {
            opacity: 0.9;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #start-original-btn {
            background-color: var(--warning-color);
        }
        /* --- Setup Screen --- */
        .input-group {
            margin: 1.5rem 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .input-group input {
            padding: 0.7rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 90%;
            max-width: 300px;
            text-align: center;
        }
        #player-names-container {
            margin-top: 1rem;
            display: grid;
            gap: 0.5rem;
        }
        .start-buttons {
            margin-top: 1.5rem;
        }
        /* --- Game Screen --- */
        #game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
            font-weight: bold;
            background: #f9f9f9;
            padding: 0.8rem;
            border-radius: 8px;
        }
        #theme-display {
            background: var(--light-color);
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            font-size: 1.2rem;
            font-weight: bold;
            line-height: 1.5;
        }
        #field-container {
            margin-bottom: 1.5rem;
        }
        #field {
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            gap: 0.5rem;
        }
        .card {
            width: 60px;
            height: 90px;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.3s, background-color 0.3s;
        }
        .field-card {
            background: var(--dark-color);
        }
        .error-card {
            background: var(--danger-color);
            animation: shake 0.5s;
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-8px); }
          75% { transform: translateX(8px); }
        }
        #players-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .player-pod {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .player-pod h3 {
            margin-bottom: 0.8rem;
        }
        .player-pod .card-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            min-height: 50px;
            margin-bottom: 0.8rem;
        }
        .player-pod button {
            width: 100%;
            padding: 0.6rem;
            font-size: 0.9rem;
        }
        .player-pod .play-btn {
            background-color: var(--secondary-color);
        }
         .player-pod .play-btn:hover {
            background-color: #27ae60;
        }
        #game-controls {
            margin-top: 2rem;
        }
        /* --- Result Screen --- */
        #result-message {
            font-size: 2rem;
        }
        #result-details {
            margin: 1rem 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        #restart-game-btn {
            background-color: var(--secondary-color);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- 1. Setup Screen -->
        <section id="setup-screen">
            <h1>ito</h1>
            <p>ã¿ã‚“ãªã§å”åŠ›ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’å°ã•ã„é †ã«å‡ºãã†ï¼</p>
            <div class="input-group">
                <label for="player-count">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•° (2ã€œ10äºº)</label>
                <input type="number" id="player-count" min="2" max="10" value="3">
            </div>
            <div id="player-names-container"></div>
            <div class="start-buttons">
                <button id="start-game-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <button id="start-original-btn">ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã§é–‹å§‹</button>
            </div>
        </section>

        <!-- 2. Game Screen -->
        <section id="game-screen" class="hidden">
            <div id="game-info">
                <p>â¤ï¸ ãƒ©ã‚¤ãƒ•: <span id="lives-display"></span></p>
                <p>ğŸ”„ ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="round-display"></span></p>
            </div>
            <div id="theme-display">ãŠé¡Œï¼š</div>
            <div id="field-container">
                <h2>å ´ã«å‡ºãŸã‚«ãƒ¼ãƒ‰</h2>
                <div id="field"></div>
            </div>
            <div id="players-container">
                <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
                <div id="players-area"></div>
            </div>
            <div id="game-controls">
                <button id="play-phase-btn">è¡¨ç¾ã‚¿ã‚¤ãƒ çµ‚äº†ï¼ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
            </div>
        </section>

        <!-- 3. Result Screen -->
        <section id="result-screen" class="hidden">
            <h2 id="result-message"></h2>
            <p id="result-details"></p>
            <button id="restart-game-btn">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        </section>
    </div>

    <!-- Game Themes List -->
    <script>
        const themes = [
            // é£Ÿã¹ç‰©ãƒ»é£²ã¿ç‰©ç·¨
            "äººæ°—ã®ã‚ã‚‹å¯¿å¸ãƒã‚¿", "å¥½ããªãƒ©ãƒ¼ãƒ¡ãƒ³ã®å‘³", "ç„¼è‚‰ã§çµ¶å¯¾é£Ÿã¹ãŸã„éƒ¨ä½", "ã‚³ãƒ³ãƒ“ãƒ‹ãŠã«ãã‚Šã®å®šç•ªå…·æ", "å¥½ããªçµ¦é£Ÿã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼", "ãŠç¥­ã‚Šã®å±‹å°ã§é£Ÿã¹ãŸã„ã‚‚ã®", "æœé£Ÿã«é£Ÿã¹ãŸã„ã‚‚ã®", "å¥½ããªãƒãƒ†ãƒˆãƒãƒƒãƒ—ã‚¹ã®å‘³", "ã‚«ãƒ•ã‚§ã§é ¼ã¿ãŸã„ãƒ‰ãƒªãƒ³ã‚¯", "ã‚«ãƒ¬ãƒ¼ã®è¾›ã•ãƒ¬ãƒ™ãƒ«", "å¥½ããªé‹æ–™ç†", "å†·è”µåº«ã«å¸¸å‚™ã—ã¦ãŠããŸã„ã‚‚ã®", "æœ€å¼·ã®ã‚«ãƒƒãƒ—éºº",
            // å‹•ç‰©ãƒ»è‡ªç„¶ç·¨
            "æœ€å¼·ã ã¨æ€ã†å‹•ç‰©", "ãƒšãƒƒãƒˆã¨ã—ã¦é£¼ã£ã¦ã¿ãŸã„å‹•ç‰©", "ã‹ã‚ã„ã„ã¨æ€ã†æµ·ã®ç”Ÿãç‰©", "ã‹ã£ã“ã„ã„ã¨æ€ã†æç«œ", "é­é‡ã—ãŸã‚‰æ€–ã„è™«", "å‹•ç‰©åœ’ã§äººæ°—ã®å‹•ç‰©", "ç¾ã—ã„ã¨æ€ã†èŠ±", "è¡Œã£ã¦ã¿ãŸã„æ—¥æœ¬ã®çµ¶æ™¯", "å¥½ããªå¤©æ°—", "ç™’ã•ã‚Œã‚‹è‡ªç„¶ã®éŸ³", "ã‚µãƒã‚¤ãƒãƒ«èƒ½åŠ›ãŒé«˜ãã†ãªå‹•ç‰©", "æ°´æ—é¤¨ã®äººæ°—è€…",
            // ãƒãƒƒãƒ—ã‚«ãƒ«ãƒãƒ£ãƒ¼ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡ç·¨
            "å›½æ°‘çš„ã‚¢ãƒ‹ãƒ¡ã¨ã„ãˆã°", "ã‚«ãƒ©ã‚ªã‚±ã§ç››ã‚Šä¸ŠãŒã‚‹æ›²", "äººç”Ÿã§ä¸€ç•ªæ³£ã„ãŸæ˜ ç”»", "å¥½ããªã‚¸ãƒ–ãƒªä½œå“", "ä¸€åº¦ã¯è¨€ã£ã¦ã¿ãŸã„ã‚¢ãƒ‹ãƒ¡ã®ã‚»ãƒªãƒ•", "å¥½ããªã‚²ãƒ¼ãƒ ã®ã‚¸ãƒ£ãƒ³ãƒ«", "å¥½ããªYouTubeãƒãƒ£ãƒ³ãƒãƒ«", "å¥½ããªãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼", "æœ€å¼·ã®ãƒãƒ¼ãƒ™ãƒ«ãƒ’ãƒ¼ãƒ­ãƒ¼", "ç¹°ã‚Šè¿”ã—è¦‹ã¦ã„ã‚‹ãƒ‰ãƒ©ãƒ", "å¥½ããªèŠ¸äºº", "å¤ã«è´ããŸã„æ›²", "ä¸»äººå…¬ã«ã—ãŸã„ä¿³å„ªãƒ»å¥³å„ª",
            // æ—¥å¸¸ç”Ÿæ´»ãƒ»ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ç·¨
            "ç„¡äººå³¶ã«ä¸€ã¤ã ã‘æŒã£ã¦ã„ãã‚‚ã®", "ä¼‘æ—¥ã®ç†æƒ³çš„ãªéã”ã—æ–¹", "ã‚³ãƒ³ãƒ“ãƒ‹ã§ã¤ã„è²·ã£ã¦ã—ã¾ã†ã‚‚ã®", "å¾—æ„ãªå®¶äº‹", "ã‚ã£ãŸã‚‰ä¾¿åˆ©ãªãƒ‰ãƒ©ãˆã‚‚ã‚“ã®ã²ã¿ã¤é“å…·", "ã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³ã§è¡Œã£ã¦ã¿ãŸã„æ™‚ä»£", "1å„„å††ã‚ã£ãŸã‚‰ã‚„ã‚ŠãŸã„ã“ã¨", "å¥½ããªå­£ç¯€", "å¯ã‚‹å‰ã«ã‚„ã‚‹ã“ã¨", "ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆæ³•", "ä½ã‚“ã§ã¿ãŸã„éƒ½é“åºœçœŒ", "ã‚¹ãƒãƒ›ã§ã‚ˆãä½¿ã†ã‚¢ãƒ—ãƒª", "å¾—æ„æ–™ç†",
            // æŠ½è±¡ãƒ»æ„Ÿæƒ…ç·¨
            "å¹¸ã›ã‚’æ„Ÿã˜ã‚‹ç¬é–“", "ã€Œé’æ˜¥ã€ã¨èã„ã¦æ€ã„æµ®ã‹ã¶ã“ã¨", "ã¡ã‚‡ã£ã¨ã—ãŸè´…æ²¢ã¨ã„ãˆã°", "å¤§äººã«ãªã£ãŸãªã¨æ„Ÿã˜ã‚‹ç¬é–“", "å‹é”ã«ã—ãŸã„äººã®ç‰¹å¾´", "ã‹ã£ã“ã„ã„ã¨æ€ã†ç”Ÿãæ–¹", "å¤§åˆ‡ã«ã—ã¦ã„ã‚‹è¨€è‘‰", "æ€ã‚ãšç¬‘ã£ã¦ã—ã¾ã†ã“ã¨", "ç†æƒ³ã®ãƒªãƒ¼ãƒ€ãƒ¼åƒ", "ã€Œã‚¨ãƒ¢ã„ã€ã¨æ„Ÿã˜ã‚‹ã‚‚ã®", "äººç”Ÿã§å¤§äº‹ãªã‚‚ã®", "å®‰å¿ƒã™ã‚‹å ´æ‰€",
            // ç©ºæƒ³ãƒ»SFç·¨
            "ã‚ã£ãŸã‚‰å¬‰ã—ã„è¶…èƒ½åŠ›", "ãªã£ã¦ã¿ãŸã„ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ä¸–ç•Œã®è·æ¥­", "ä»²é–“ã«ãªã£ã¦ã»ã—ã„RPGã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼", "ä½¿ã£ã¦ã¿ãŸã„é­”æ³•", "ä¹—ã£ã¦ã¿ãŸã„æ¶ç©ºã®ä¹—ã‚Šç‰©", "æˆ¦ã£ã¦ã¿ãŸã„ãƒ©ã‚¹ãƒœã‚¹", "ä½ã‚“ã§ã¿ãŸã„ã‚²ãƒ¼ãƒ ã®ä¸–ç•Œ", "ç¾å®Ÿä¸–ç•Œã«ã‚ã£ã¦ã»ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ", "å®‡å®™äººã«ä¼šã£ãŸã‚‰æœ€åˆã«èããŸã„ã“ã¨", "ã‚¾ãƒ³ãƒ“ã®ä¸–ç•Œã§å½¹ç«‹ã¤ã‚¹ã‚­ãƒ«", "è»¢ç”Ÿã—ãŸã‚‰ãªã‚ŠãŸã„ã‚‚ã®", "æ”¯é…ã—ãŸã„å±æ€§ï¼ˆç«ã€æ°´ã€é¢¨ãªã©ï¼‰",
            // å­¦æ ¡ãƒ»ä»•äº‹ç·¨
            "å¾—æ„ã ã£ãŸæ•™ç§‘", "ãªã‚ŠãŸã‹ã£ãŸè·æ¥­", "å¥½ããªå­¦æ ¡è¡Œäº‹", "ã‚ã£ãŸã‚‰å¬‰ã—ã„æ ¡å‰‡", "ç†æƒ³ã®ä¸Šå¸ãƒ»å…ˆè¼©", "çµ¦æ–™æ—¥ã«é£Ÿã¹ãŸã„ã‚‚ã®", "ä»•äº‹ã§ã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ã‚‹ç¬é–“", "å­¦ç”Ÿæ™‚ä»£ã«æˆ»ã£ã¦ã‚„ã‚Šç›´ã—ãŸã„ã“ã¨", "ã‚„ã£ã¦ã¿ãŸã„ã‚¢ãƒ«ãƒã‚¤ãƒˆ", "è‹¦æ‰‹ã ã£ãŸéƒ¨æ´»å‹•", "ã“ã‚“ãªä¼šç¤¾ã¯å«Œã ", "ä¼‘æ†©æ™‚é–“ã«ã‚ˆãã™ã‚‹ã“ã¨",
            // ãŠã‚‚ã—ã‚ãƒ»ãŠãƒã‚«ç³»ç·¨
            "åœ°å‘³ã«ç—›ã„ã“ã¨", "çµ¶å¯¾ã«å‹é”ã«ãªã‚Œãªã„ã‚¿ã‚¤ãƒ—", "å­ä¾›ã®é ƒã®æ¥ãšã‹ã—ã„å‹˜é•ã„", "è‡ªåˆ†ã—ã‹çŸ¥ã‚‰ãªã„è¬ãƒ«ãƒ¼ãƒ«", "ã€Œç¥æ§˜ã€ã¨èã„ã¦æ€ã„æµ®ã‹ã¶è¦‹ãŸç›®", "æ˜æ—¥ä¸–ç•ŒãŒçµ‚ã‚ã‚‹ãªã‚‰æœ€å¾Œã«é£Ÿã¹ãŸã„ã‚‚ã®", "æœ€å¼·ã®èª¿å‘³æ–™", "ä¸€ç•ªãƒ€ã‚µã„ã¨æ€ã†ãƒãƒ¼ã‚º", "ç„¡é§„ã«ã‹ã£ã“ã„ã„è¨€è‘‰", "é…åˆ»ã—ãŸæ™‚ã®è¨€ã„è¨³", "ã‚¯ãƒ©ã‚¹ã«ä¸€äººã¯ã„ãŸå¤‰ãªã‚„ã¤", "äººã«è¨€ãˆãªã„ã¡ã‚‡ã£ã¨ã—ãŸè‡ªæ…¢", "ã“ã‚Œã ã‘ã¯è¨±ã›ãªã„é£Ÿã¹æ–¹"
        ];
    </script>
    
    <!-- Game Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const setupScreen = document.getElementById('setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const resultScreen = document.getElementById('result-screen');
            
            const playerCountInput = document.getElementById('player-count');
            const playerNamesContainer = document.getElementById('player-names-container');
            const startGameBtn = document.getElementById('start-game-btn');
            const startOriginalBtn = document.getElementById('start-original-btn');

            const livesDisplay = document.getElementById('lives-display');
            const roundDisplay = document.getElementById('round-display');
            const themeDisplay = document.getElementById('theme-display');
            const fieldDisplay = document.getElementById('field');
            const playersArea = document.getElementById('players-area');
            const playPhaseBtn = document.getElementById('play-phase-btn');

            const resultMessage = document.getElementById('result-message');
            const resultDetails = document.getElementById('result-details');
            const restartGameBtn = document.getElementById('restart-game-btn');

            // --- Game State ---
            let state = {};

            function resetState() {
                state = {
                    players: [],
                    deck: [],
                    fieldCards: [],
                    lives: 0,
                    round: 0,
                    maxRounds: 3,
                    isOriginalMode: false, // Flag for original theme mode
                    gamePhase: 'view', // 'view' or 'play'
                    playedPlayerCount: 0,
                    gameActive: false,
                };
            }

            // --- Event Listeners ---
            playerCountInput.addEventListener('input', setupPlayerNameInputs);
            startGameBtn.addEventListener('click', () => startGame(false)); // Normal Mode
            startOriginalBtn.addEventListener('click', () => startGame(true)); // Original Mode
            playPhaseBtn.addEventListener('click', startPlayPhase);
            restartGameBtn.addEventListener('click', resetGame);

            // --- Functions ---
            function setupPlayerNameInputs() {
                const count = parseInt(playerCountInput.value, 10) || 0;
                playerNamesContainer.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i + 1} ã®åå‰`;
                    input.id = `player-name-${i}`;
                    playerNamesContainer.appendChild(input);
                }
            }

            function startGame(isOriginal = false) {
                resetState();
                state.isOriginalMode = isOriginal;

                const playerCount = parseInt(playerCountInput.value, 10);
                if (playerCount < 2) {
                    alert('2äººä»¥ä¸Šã§ãƒ—ãƒ¬ã‚¤ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                for (let i = 0; i < playerCount; i++) {
                    const nameInput = document.getElementById(`player-name-${i}`);
                    state.players.push({
                        id: i,
                        name: nameInput.value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i + 1}`,
                        card: null,
                        hasPlayed: false,
                    });
                }

                state.lives = state.players.length;
                state.gameActive = true;
                
                startNewRound();

                setupScreen.classList.add('hidden');
                resultScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
            }

            function startNewRound() {
                state.round++;
                if (state.round > state.maxRounds && !state.isOriginalMode) {
                    endGame(true); // Cleared all rounds in normal mode
                    return;
                }

                state.fieldCards = [];
                state.playedPlayerCount = 0;
                state.gamePhase = 'view';
                
                state.deck = Array.from({ length: 100 }, (_, i) => i + 1);
                shuffle(state.deck);

                state.players.forEach(player => {
                    player.card = state.deck.pop();
                    player.hasPlayed = false;
                });
                
                updateUI();
            }

            function startPlayPhase() {
                state.gamePhase = 'play';
                updateUI();
            }

            function viewCard(playerId) {
                const player = state.players.find(p => p.id === playerId);
                const cardDisplay = document.querySelector(`.player-pod[data-id="${playerId}"] .card-display`);
                const viewBtn = document.querySelector(`.player-pod[data-id="${playerId}"] .view-btn`);
                
                if (cardDisplay.textContent === '?') {
                    cardDisplay.textContent = player.card;
                    viewBtn.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’éš ã™';
                } else {
                    cardDisplay.textContent = '?';
                    viewBtn.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹';
                }
            }

            function playCard(playerId) {
                if (state.gamePhase !== 'play') return;

                const player = state.players.find(p => p.id === playerId);
                if (player.hasPlayed) return;

                player.hasPlayed = true;
                state.playedPlayerCount++;
                const number = player.card;

                const cardDiv = document.createElement('div');
                cardDiv.className = 'card field-card';
                cardDiv.textContent = number;

                const lastCard = state.fieldCards.length > 0 ? state.fieldCards[state.fieldCards.length - 1] : 0;
                if (number < lastCard) {
                    state.lives--;
                    cardDiv.classList.add('error-card');
                    const livesElement = document.getElementById('lives-display');
                    livesElement.style.transform = 'scale(1.5)';
                    setTimeout(() => livesElement.style.transform = 'scale(1)', 200);

                    if (state.lives <= 0) {
                        endGame(false);
                        return;
                    }
                }
                
                state.fieldCards.push(number);
                state.fieldCards.sort((a, b) => a - b);

                updateUI();

                if (state.playedPlayerCount === state.players.length) {
                    // All players have played their cards
                    if (state.isOriginalMode) {
                        // Original mode ends after one round
                        setTimeout(() => endGame(true, true), 1500);
                    } else {
                        // Normal mode proceeds to the next round
                        setTimeout(() => {
                            alert(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${state.round} ã‚¯ãƒªã‚¢ï¼`);
                            startNewRound();
                        }, 1500);
                    }
                }
            }
            
            function updateUI() {
                if (!state.gameActive) return;

                livesDisplay.textContent = state.lives;
                roundDisplay.textContent = state.isOriginalMode ? 'ã‚ªãƒªã‚¸ãƒŠãƒ«' : `${state.round} / ${state.maxRounds}`;
                
                // Change theme display based on mode
                if (state.isOriginalMode) {
                    themeDisplay.textContent = 'ãŠé¡Œã¯è‡ªç”±ï¼ã¿ã‚“ãªã§æ±ºã‚ã¦è©±ã—åˆãŠã†ï¼';
                } else {
                    // Pick from the shuffled themes list
                    const themeIndex = (state.round - 1) % themes.length;
                    themeDisplay.textContent = `ãŠé¡Œï¼š${themes[themeIndex]}`;
                }
                
                fieldDisplay.innerHTML = '';
                state.fieldCards.forEach(cardNum => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card field-card';
                    cardDiv.textContent = cardNum;
                    fieldDisplay.appendChild(cardDiv);
                });

                playersArea.innerHTML = '';
                state.players.forEach(player => {
                    const pod = document.createElement('div');
                    pod.className = 'player-pod';
                    pod.dataset.id = player.id;
                    
                    const canPlay = state.gamePhase === 'play' && !player.hasPlayed;

                    pod.innerHTML = `
                        <h3>${player.name}</h3>
                        <div class="card-display">?</div>
                        <button class="view-btn" ${state.gamePhase === 'play' ? 'disabled' : ''}>ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</button>
                        <button class="play-btn" ${!canPlay ? 'disabled' : ''}>ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
                    `;
                    playersArea.appendChild(pod);
                });

                document.querySelectorAll('.view-btn').forEach(btn => {
                    const id = parseInt(btn.closest('.player-pod').dataset.id, 10);
                    btn.addEventListener('click', () => viewCard(id));
                });
                document.querySelectorAll('.play-btn').forEach(btn => {
                    const id = parseInt(btn.closest('.player-pod').dataset.id, 10);
                    btn.addEventListener('click', () => playCard(id));
                });
                
                playPhaseBtn.classList.toggle('hidden', state.gamePhase === 'play');
            }

            function endGame(isWin, fromOriginal = false) {
                state.gameActive = false;
                gameScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');

                const correctOrder = state.players.map(p => p.card).sort((a,b) => a - b).join(' â†’ ');

                if (isWin) {
                    if (fromOriginal) {
                        resultMessage.textContent = 'ğŸ‰ çµ‚äº†ï¼ ğŸ‰';
                        resultDetails.innerHTML = `ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br>ä»Šå›ã®æ•°å­—ã®é †ç•ªã¯: ${correctOrder}`;
                    } else {
                        resultMessage.textContent = 'ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰';
                        resultDetails.textContent = 'ç´ æ™´ã‚‰ã—ã„å”åŠ›ã§ã—ãŸï¼';
                    }
                } else {
                    resultMessage.textContent = 'ğŸ˜¢ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ğŸ˜¢';
                    resultDetails.innerHTML = `ãƒ©ã‚¤ãƒ•ãŒ0ã«ãªã‚Šã¾ã—ãŸã€‚<br>ä»Šå›ã®æ­£è§£ã¯: ${correctOrder}`;
                }
            }

            function resetGame() {
                resultScreen.classList.add('hidden');
                gameScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
                resetState();
                setupPlayerNameInputs();
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // --- Initialization ---
            resetState();
            setupPlayerNameInputs();
            // Shuffle themes before the game starts
            shuffle(themes);
        });
    </script>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
