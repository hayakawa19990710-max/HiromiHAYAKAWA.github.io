<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ito - The Game</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3a98db"/>
    <style>
        /* --- General Styles --- */
        :root {
            --primary-color: #3a98db;
            --secondary-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 1rem;
        }
        #app-container {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
        h1 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        h2 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            margin: 0.25rem;
        }
        button:hover {
            opacity: 0.9;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #start-original-btn {
            background-color: var(--warning-color);
        }
        /* --- Setup Screen --- */
        .input-group {
            margin: 1.5rem 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .input-group input {
            padding: 0.7rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 90%;
            max-width: 300px;
            text-align: center;
        }
        #player-names-container {
            margin-top: 1rem;
            display: grid;
            gap: 0.5rem;
        }
        .start-buttons {
            margin-top: 1.5rem;
        }
        /* --- Game Screen --- */
        #game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
            font-weight: bold;
            background: #f9f9f9;
            padding: 0.8rem;
            border-radius: 8px;
        }
        #theme-display {
            background: var(--light-color);
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            font-size: 1.2rem;
            font-weight: bold;
            line-height: 1.5;
        }
        #field-container {
            margin-bottom: 1.5rem;
        }
        #field {
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            gap: 0.5rem;
        }
        .card {
            width: 60px;
            height: 90px;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.3s, background-color 0.3s;
        }
        .field-card {
            background: var(--dark-color);
        }
        .error-card {
            background: var(--danger-color);
            animation: shake 0.5s;
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-8px); }
          75% { transform: translateX(8px); }
        }
        #players-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .player-pod {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .player-pod h3 {
            margin-bottom: 0.8rem;
        }
        .player-pod .card-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            min-height: 50px;
            margin-bottom: 0.8rem;
        }
        .player-pod button {
            width: 100%;
            padding: 0.6rem;
            font-size: 0.9rem;
        }
        .player-pod .play-btn {
            background-color: var(--secondary-color);
        }
         .player-pod .play-btn:hover {
            background-color: #27ae60;
        }
        #game-controls {
            margin-top: 2rem;
        }
        /* --- Result Screen --- */
        #result-message {
            font-size: 2rem;
        }
        #result-details {
            margin: 1rem 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        #restart-game-btn {
            background-color: var(--secondary-color);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- 1. Setup Screen -->
        <section id="setup-screen">
            <h1>ito</h1>
            <p>みんなで協力してカードを小さい順に出そう！</p>
            <div class="input-group">
                <label for="player-count">プレイヤー人数 (2〜10人)</label>
                <input type="number" id="player-count" min="2" max="10" value="3">
            </div>
            <div id="player-names-container"></div>
            <div class="start-buttons">
                <button id="start-game-btn">ゲーム開始</button>
                <button id="start-original-btn">オリジナル問題で開始</button>
            </div>
        </section>

        <!-- 2. Game Screen -->
        <section id="game-screen" class="hidden">
            <div id="game-info">
                <p>❤️ ライフ: <span id="lives-display"></span></p>
                <p>🔄 ラウンド: <span id="round-display"></span></p>
            </div>
            <div id="theme-display">お題：</div>
            <div id="field-container">
                <h2>場に出たカード</h2>
                <div id="field"></div>
            </div>
            <div id="players-container">
                <h2>プレイヤー</h2>
                <div id="players-area"></div>
            </div>
            <div id="game-controls">
                <button id="play-phase-btn">表現タイム終了！カードを出す</button>
            </div>
        </section>

        <!-- 3. Result Screen -->
        <section id="result-screen" class="hidden">
            <h2 id="result-message"></h2>
            <p id="result-details"></p>
            <button id="restart-game-btn">もう一度遊ぶ</button>
        </section>
    </div>

    <!-- Game Themes List -->
    <script>
        const themes = [
            // 食べ物・飲み物編
            "人気のある寿司ネタ", "好きなラーメンの味", "焼肉で絶対食べたい部位", "コンビニおにぎりの定番具材", "好きな給食のメニュー", "お祭りの屋台で食べたいもの", "朝食に食べたいもの", "好きなポテトチップスの味", "カフェで頼みたいドリンク", "カレーの辛さレベル", "好きな鍋料理", "冷蔵庫に常備しておきたいもの", "最強のカップ麺",
            // 動物・自然編
            "最強だと思う動物", "ペットとして飼ってみたい動物", "かわいいと思う海の生き物", "かっこいいと思う恐竜", "遭遇したら怖い虫", "動物園で人気の動物", "美しいと思う花", "行ってみたい日本の絶景", "好きな天気", "癒される自然の音", "サバイバル能力が高そうな動物", "水族館の人気者",
            // ポップカルチャー・エンタメ編
            "国民的アニメといえば", "カラオケで盛り上がる曲", "人生で一番泣いた映画", "好きなジブリ作品", "一度は言ってみたいアニメのセリフ", "好きなゲームのジャンル", "好きなYouTubeチャンネル", "好きなディズニーキャラクター", "最強のマーベルヒーロー", "繰り返し見ているドラマ", "好きな芸人", "夏に聴きたい曲", "主人公にしたい俳優・女優",
            // 日常生活・ライフスタイル編
            "無人島に一つだけ持っていくもの", "休日の理想的な過ごし方", "コンビニでつい買ってしまうもの", "得意な家事", "あったら便利なドラえもんのひみつ道具", "タイムマシンで行ってみたい時代", "1億円あったらやりたいこと", "好きな季節", "寝る前にやること", "ストレス解消法", "住んでみたい都道府県", "スマホでよく使うアプリ", "得意料理",
            // 抽象・感情編
            "幸せを感じる瞬間", "「青春」と聞いて思い浮かぶこと", "ちょっとした贅沢といえば", "大人になったなと感じる瞬間", "友達にしたい人の特徴", "かっこいいと思う生き方", "大切にしている言葉", "思わず笑ってしまうこと", "理想のリーダー像", "「エモい」と感じるもの", "人生で大事なもの", "安心する場所",
            // 空想・SF編
            "あったら嬉しい超能力", "なってみたいファンタジー世界の職業", "仲間になってほしいRPGのキャラクター", "使ってみたい魔法", "乗ってみたい架空の乗り物", "戦ってみたいラスボス", "住んでみたいゲームの世界", "現実世界にあってほしいアイテム", "宇宙人に会ったら最初に聞きたいこと", "ゾンビの世界で役立つスキル", "転生したらなりたいもの", "支配したい属性（火、水、風など）",
            // 学校・仕事編
            "得意だった教科", "なりたかった職業", "好きな学校行事", "あったら嬉しい校則", "理想の上司・先輩", "給料日に食べたいもの", "仕事でやりがいを感じる瞬間", "学生時代に戻ってやり直したいこと", "やってみたいアルバイト", "苦手だった部活動", "こんな会社は嫌だ", "休憩時間によくすること",
            // おもしろ・おバカ系編
            "地味に痛いこと", "絶対に友達になれないタイプ", "子供の頃の恥ずかしい勘違い", "自分しか知らない謎ルール", "「神様」と聞いて思い浮かぶ見た目", "明日世界が終わるなら最後に食べたいもの", "最強の調味料", "一番ダサいと思うポーズ", "無駄にかっこいい言葉", "遅刻した時の言い訳", "クラスに一人はいた変なやつ", "人に言えないちょっとした自慢", "これだけは許せない食べ方"
        ];
    </script>
    
    <!-- Game Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const setupScreen = document.getElementById('setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const resultScreen = document.getElementById('result-screen');
            
            const playerCountInput = document.getElementById('player-count');
            const playerNamesContainer = document.getElementById('player-names-container');
            const startGameBtn = document.getElementById('start-game-btn');
            const startOriginalBtn = document.getElementById('start-original-btn');

            const livesDisplay = document.getElementById('lives-display');
            const roundDisplay = document.getElementById('round-display');
            const themeDisplay = document.getElementById('theme-display');
            const fieldDisplay = document.getElementById('field');
            const playersArea = document.getElementById('players-area');
            const playPhaseBtn = document.getElementById('play-phase-btn');

            const resultMessage = document.getElementById('result-message');
            const resultDetails = document.getElementById('result-details');
            const restartGameBtn = document.getElementById('restart-game-btn');

            // --- Game State ---
            let state = {};

            function resetState() {
                state = {
                    players: [],
                    deck: [],
                    fieldCards: [],
                    lives: 0,
                    round: 0,
                    maxRounds: 3,
                    isOriginalMode: false, // Flag for original theme mode
                    gamePhase: 'view', // 'view' or 'play'
                    playedPlayerCount: 0,
                    gameActive: false,
                };
            }

            // --- Event Listeners ---
            playerCountInput.addEventListener('input', setupPlayerNameInputs);
            startGameBtn.addEventListener('click', () => startGame(false)); // Normal Mode
            startOriginalBtn.addEventListener('click', () => startGame(true)); // Original Mode
            playPhaseBtn.addEventListener('click', startPlayPhase);
            restartGameBtn.addEventListener('click', resetGame);

            // --- Functions ---
            function setupPlayerNameInputs() {
                const count = parseInt(playerCountInput.value, 10) || 0;
                playerNamesContainer.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `プレイヤー ${i + 1} の名前`;
                    input.id = `player-name-${i}`;
                    playerNamesContainer.appendChild(input);
                }
            }

            function startGame(isOriginal = false) {
                resetState();
                state.isOriginalMode = isOriginal;

                const playerCount = parseInt(playerCountInput.value, 10);
                if (playerCount < 2) {
                    alert('2人以上でプレイしてください。');
                    return;
                }

                for (let i = 0; i < playerCount; i++) {
                    const nameInput = document.getElementById(`player-name-${i}`);
                    state.players.push({
                        id: i,
                        name: nameInput.value || `プレイヤー ${i + 1}`,
                        card: null,
                        hasPlayed: false,
                    });
                }

                state.lives = state.players.length;
                state.gameActive = true;
                
                startNewRound();

                setupScreen.classList.add('hidden');
                resultScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
            }

            function startNewRound() {
                state.round++;
                if (state.round > state.maxRounds && !state.isOriginalMode) {
                    endGame(true); // Cleared all rounds in normal mode
                    return;
                }

                state.fieldCards = [];
                state.playedPlayerCount = 0;
                state.gamePhase = 'view';
                
                state.deck = Array.from({ length: 100 }, (_, i) => i + 1);
                shuffle(state.deck);

                state.players.forEach(player => {
                    player.card = state.deck.pop();
                    player.hasPlayed = false;
                });
                
                updateUI();
            }

            function startPlayPhase() {
                state.gamePhase = 'play';
                updateUI();
            }

            function viewCard(playerId) {
                const player = state.players.find(p => p.id === playerId);
                const cardDisplay = document.querySelector(`.player-pod[data-id="${playerId}"] .card-display`);
                const viewBtn = document.querySelector(`.player-pod[data-id="${playerId}"] .view-btn`);
                
                if (cardDisplay.textContent === '?') {
                    cardDisplay.textContent = player.card;
                    viewBtn.textContent = 'カードを隠す';
                } else {
                    cardDisplay.textContent = '?';
                    viewBtn.textContent = 'カードを見る';
                }
            }

            function playCard(playerId) {
                if (state.gamePhase !== 'play') return;

                const player = state.players.find(p => p.id === playerId);
                if (player.hasPlayed) return;

                player.hasPlayed = true;
                state.playedPlayerCount++;
                const number = player.card;

                const cardDiv = document.createElement('div');
                cardDiv.className = 'card field-card';
                cardDiv.textContent = number;

                const lastCard = state.fieldCards.length > 0 ? state.fieldCards[state.fieldCards.length - 1] : 0;
                if (number < lastCard) {
                    state.lives--;
                    cardDiv.classList.add('error-card');
                    const livesElement = document.getElementById('lives-display');
                    livesElement.style.transform = 'scale(1.5)';
                    setTimeout(() => livesElement.style.transform = 'scale(1)', 200);

                    if (state.lives <= 0) {
                        endGame(false);
                        return;
                    }
                }
                
                state.fieldCards.push(number);
                state.fieldCards.sort((a, b) => a - b);

                updateUI();

                if (state.playedPlayerCount === state.players.length) {
                    // All players have played their cards
                    if (state.isOriginalMode) {
                        // Original mode ends after one round
                        setTimeout(() => endGame(true, true), 1500);
                    } else {
                        // Normal mode proceeds to the next round
                        setTimeout(() => {
                            alert(`ラウンド ${state.round} クリア！`);
                            startNewRound();
                        }, 1500);
                    }
                }
            }
            
            function updateUI() {
                if (!state.gameActive) return;

                livesDisplay.textContent = state.lives;
                roundDisplay.textContent = state.isOriginalMode ? 'オリジナル' : `${state.round} / ${state.maxRounds}`;
                
                // Change theme display based on mode
                if (state.isOriginalMode) {
                    themeDisplay.textContent = 'お題は自由！みんなで決めて話し合おう！';
                } else {
                    // Pick from the shuffled themes list
                    const themeIndex = (state.round - 1) % themes.length;
                    themeDisplay.textContent = `お題：${themes[themeIndex]}`;
                }
                
                fieldDisplay.innerHTML = '';
                state.fieldCards.forEach(cardNum => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card field-card';
                    cardDiv.textContent = cardNum;
                    fieldDisplay.appendChild(cardDiv);
                });

                playersArea.innerHTML = '';
                state.players.forEach(player => {
                    const pod = document.createElement('div');
                    pod.className = 'player-pod';
                    pod.dataset.id = player.id;
                    
                    const canPlay = state.gamePhase === 'play' && !player.hasPlayed;

                    pod.innerHTML = `
                        <h3>${player.name}</h3>
                        <div class="card-display">?</div>
                        <button class="view-btn" ${state.gamePhase === 'play' ? 'disabled' : ''}>カードを見る</button>
                        <button class="play-btn" ${!canPlay ? 'disabled' : ''}>このカードを出す</button>
                    `;
                    playersArea.appendChild(pod);
                });

                document.querySelectorAll('.view-btn').forEach(btn => {
                    const id = parseInt(btn.closest('.player-pod').dataset.id, 10);
                    btn.addEventListener('click', () => viewCard(id));
                });
                document.querySelectorAll('.play-btn').forEach(btn => {
                    const id = parseInt(btn.closest('.player-pod').dataset.id, 10);
                    btn.addEventListener('click', () => playCard(id));
                });
                
                playPhaseBtn.classList.toggle('hidden', state.gamePhase === 'play');
            }

            function endGame(isWin, fromOriginal = false) {
                state.gameActive = false;
                gameScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');

                const correctOrder = state.players.map(p => p.card).sort((a,b) => a - b).join(' → ');

                if (isWin) {
                    if (fromOriginal) {
                        resultMessage.textContent = '🎉 終了！ 🎉';
                        resultDetails.innerHTML = `お疲れ様でした！<br>今回の数字の順番は: ${correctOrder}`;
                    } else {
                        resultMessage.textContent = '🎉 ゲームクリア！ 🎉';
                        resultDetails.textContent = '素晴らしい協力でした！';
                    }
                } else {
                    resultMessage.textContent = '😢 ゲームオーバー 😢';
                    resultDetails.innerHTML = `ライフが0になりました。<br>今回の正解は: ${correctOrder}`;
                }
            }

            function resetGame() {
                resultScreen.classList.add('hidden');
                gameScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
                resetState();
                setupPlayerNameInputs();
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // --- Initialization ---
            resetState();
            setupPlayerNameInputs();
            // Shuffle themes before the game starts
            shuffle(themes);
        });
    </script>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
